<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第9頁 - 事業版圖</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 自訂義心智圖樣式 */
        #mindmap {
            position: relative;
            width: 100%;
            height: 600px;
            border: 1px dashed #ddd;
            border-radius: 4px;
            background: #fdfdfd;
            margin-top: 1rem;
        }
        .node {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid #0077cc;
            background: #eef7ff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            cursor: move;
            overflow: hidden;
        }
        .node input {
            width: 70px;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 12px;
            outline: none;
        }
        /* 線段樣式 */
        .line {
            position: absolute;
            height: 2px;
            background: #0077cc;
            transform-origin: 0 0;
        }
        /* 線段端點拖曳手柄 */
        .line-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #0077cc;
            border-radius: 50%;
            cursor: move;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="page8.html">上一頁</a>
            <a href="home.html">首頁</a>
            <!-- 下一頁改為客戶資料管理頁 -->
            <a href="customer_management.html">下一頁</a>
        </nav>
        <h2>事業版圖</h2>
        <p>在此製作一個可編輯的心智圖，可新增及移動成員並自動儲存。</p>
        <!-- 新增說明提示 -->
        <p>說明：連續點擊兩下可以刪除線段、成員</p>
        <!-- 容器：承載所有節點 -->
        <div id="mindmap"></div>
        <!-- 操作按鈕 -->
        <div style="margin-top:10px;">
            <button id="add-member-btn">新增成員</button>
            <button id="add-line-btn">新增線段</button>
        </div>
        <!-- 心智圖腳本 -->
        <script>
        (function() {
            const container = document.getElementById('mindmap');
            const addMemberBtn = document.getElementById('add-member-btn');
            const addLineBtn = document.getElementById('add-line-btn');
            let nodesData = [];
            let linesData = [];
            try {
                nodesData = JSON.parse(localStorage.getItem('mindmapNodes')) || [];
                linesData = JSON.parse(localStorage.getItem('mindmapLines')) || [];
            } catch(e) {
                nodesData = [];
                linesData = [];
            }
            function save() {
                localStorage.setItem('mindmapNodes', JSON.stringify(nodesData));
                localStorage.setItem('mindmapLines', JSON.stringify(linesData));
            }
            // 觸控支援：取得事件座標
            function getCoords(ev) {
                if (ev.touches && ev.touches.length > 0) {
                    return { x: ev.touches[0].clientX, y: ev.touches[0].clientY };
                }
                return { x: ev.clientX, y: ev.clientY };
            }

            // 用於偵測雙擊或雙觸
            let lastTapTime = 0;
            let lastTapTarget = null;

            function renderAll() {
                container.innerHTML = '';
                // 渲染線段
                linesData.forEach((line) => {
                    const lineEl = document.createElement('div');
                    lineEl.className = 'line';
                    const handleStart = document.createElement('div');
                    handleStart.className = 'line-handle';
                    const handleEnd = document.createElement('div');
                    handleEnd.className = 'line-handle';
                    function update() {
                        const dx = line.x2 - line.x1;
                        const dy = line.y2 - line.y1;
                        const length = Math.sqrt(dx * dx + dy * dy);
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                        lineEl.style.width = length + 'px';
                        lineEl.style.left = line.x1 + 'px';
                        lineEl.style.top = line.y1 + 'px';
                        lineEl.style.transform = 'rotate(' + angle + 'deg)';
                        handleStart.style.left = line.x1 + 'px';
                        handleStart.style.top = line.y1 + 'px';
                        handleEnd.style.left = line.x2 + 'px';
                        handleEnd.style.top = line.y2 + 'px';
                    }
                    function attachHandle(handle, suffix) {
                        // 滑鼠拖曳
                        function startDrag(ev) {
                            ev.preventDefault();
                            const coords = getCoords(ev);
                            const offsetX = coords.x - line['x' + suffix];
                            const offsetY = coords.y - line['y' + suffix];
                            function move(moveEv) {
                                const c = getCoords(moveEv);
                                line['x' + suffix] = c.x - offsetX;
                                line['y' + suffix] = c.y - offsetY;
                                update();
                            }
                            function endDrag() {
                                document.removeEventListener('mousemove', move);
                                document.removeEventListener('mouseup', endDrag);
                                document.removeEventListener('touchmove', move);
                                document.removeEventListener('touchend', endDrag);
                                save();
                            }
                            document.addEventListener('mousemove', move);
                            document.addEventListener('mouseup', endDrag);
                            document.addEventListener('touchmove', move);
                            document.addEventListener('touchend', endDrag);
                        }
                        handle.addEventListener('mousedown', startDrag);
                        handle.addEventListener('touchstart', startDrag);

                        // 雙擊/雙觸刪除線段或端點
                        handle.addEventListener('dblclick', () => {
                            removeLine();
                        });
                        handle.addEventListener('touchstart', (ev) => {
                            const now = Date.now();
                            if (lastTapTarget === handle && now - lastTapTime < 400) {
                                // double tap
                                removeLine();
                                lastTapTarget = null;
                            } else {
                                lastTapTarget = handle;
                                lastTapTime = now;
                            }
                        });
                    }
                    // 雙擊線段或端點刪除
                    function removeLine() {
                        const idx = linesData.indexOf(line);
                        if (idx !== -1) {
                            linesData.splice(idx, 1);
                            save();
                            renderAll();
                        }
                    }
                    // 掛載端點拖曳：傳入 '1' 或 '2' 對應 x1/y1 和 x2/y2
                    attachHandle(handleStart, '1');
                    attachHandle(handleEnd, '2');
                    // 用於刪除整條線段的觸發
                    lineEl.addEventListener('dblclick', removeLine);
                    lineEl.addEventListener('touchstart', (ev) => {
                        const now = Date.now();
                        if (lastTapTarget === lineEl && now - lastTapTime < 400) {
                            removeLine();
                            lastTapTarget = null;
                        } else {
                            lastTapTarget = lineEl;
                            lastTapTime = now;
                        }
                    });
                    container.appendChild(lineEl);
                    container.appendChild(handleStart);
                    container.appendChild(handleEnd);
                    update();
                });
                // 渲染節點
                nodesData.forEach((node) => {
                    const nodeEl = document.createElement('div');
                    nodeEl.className = 'node';
                    nodeEl.style.left = node.x + 'px';
                    nodeEl.style.top = node.y + 'px';
                    const input = document.createElement('input');
                    input.value = node.text || '';
                    input.addEventListener('input', () => {
                        node.text = input.value;
                        save();
                    });
                    // 防止在輸入框內雙擊觸發節點刪除
                    input.addEventListener('dblclick', (e) => {
                        e.stopPropagation();
                    });
                    nodeEl.appendChild(input);
                    // 藉由滑鼠或觸控拖曳節點
                    function startNodeDrag(ev) {
                        // 若點擊的是輸入框，不啟動拖曳
                        if (ev.target.tagName && ev.target.tagName.toLowerCase() === 'input') {
                            return;
                        }
                        ev.preventDefault();
                        const coords = getCoords(ev);
                        const startX = coords.x - node.x;
                        const startY = coords.y - node.y;
                        function move(moveEv) {
                            const c = getCoords(moveEv);
                            node.x = c.x - startX;
                            node.y = c.y - startY;
                            nodeEl.style.left = node.x + 'px';
                            nodeEl.style.top = node.y + 'px';
                        }
                        function endDrag() {
                            document.removeEventListener('mousemove', move);
                            document.removeEventListener('mouseup', endDrag);
                            document.removeEventListener('touchmove', move);
                            document.removeEventListener('touchend', endDrag);
                            save();
                        }
                        document.addEventListener('mousemove', move);
                        document.addEventListener('mouseup', endDrag);
                        document.addEventListener('touchmove', move);
                        document.addEventListener('touchend', endDrag);
                    }
                    nodeEl.addEventListener('mousedown', startNodeDrag);
                    nodeEl.addEventListener('touchstart', (ev) => {
                        // 雙觸刪除節點
                        const now = Date.now();
                        if (lastTapTarget === nodeEl && now - lastTapTime < 400) {
                            const idx = nodesData.indexOf(node);
                            if (idx !== -1) {
                                nodesData.splice(idx, 1);
                                save();
                                renderAll();
                            }
                            lastTapTarget = null;
                            return;
                        }
                        // 記錄此次點擊
                        lastTapTarget = nodeEl;
                        lastTapTime = now;
                        startNodeDrag(ev);
                    });
                    // 雙擊刪除節點（桌面）
                    nodeEl.addEventListener('dblclick', () => {
                        const idx = nodesData.indexOf(node);
                        if (idx !== -1) {
                            nodesData.splice(idx, 1);
                            save();
                            renderAll();
                        }
                    });
                    container.appendChild(nodeEl);
                });
            }
            // 初始化預設節點
            if (nodesData.length === 0) {
                const cw = container.clientWidth;
                const ch = container.clientHeight;
                const cx = cw / 2 - 40;
                const cy = ch / 2 - 40;
                nodesData.push({ x: cx, y: cy, text: '核心' });
                const radius = 200;
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    const x = cx + radius * Math.cos(angle);
                    const y = cy + radius * Math.sin(angle);
                    nodesData.push({ x, y, text: '成員' + (i + 1) });
                }
                save();
            }
            if (!Array.isArray(linesData)) {
                linesData = [];
                save();
            }
            addMemberBtn.addEventListener('click', () => {
                const x = 20 + nodesData.length * 20;
                const y = 20 + nodesData.length * 20;
                nodesData.push({ x, y, text: '新成員' });
                save();
                renderAll();
            });
            addLineBtn.addEventListener('click', () => {
                const newLine = { x1: 100, y1: 100, x2: 200, y2: 200 };
                linesData.push(newLine);
                save();
                renderAll();
            });
            renderAll();
        })();
        </script>
    </div>
</body>
</html>